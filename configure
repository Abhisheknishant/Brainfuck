#!/bin/sh -

MF=make.conf

[ -f $MF ] || {
    cat >$MF <<\!
DEFS_LIGHTNING=
DEFS_TCCLIB=
LIBS_LIGHTNING=
LIBS_TCCLIB=
DEFS=$(DEFS_TCCLIB) $(DEFS_LIGHTNING)
LIBS=$(LIBS_TCCLIB) $(LIBS_LIGHTNING)
!
}

sed \
    -e 's/^DEFS_LIGHTNING=.*/DEFS_LIGHTNING=/' \
    -e 's/^DEFS_TCCLIB=.*/DEFS_TCCLIB=/' \
    -e 's/^LIBS_LIGHTNING=.*/LIBS_LIGHTNING=/' \
    -e 's/^LIBS_TCCLIB=.*/LIBS_TCCLIB=/' \
    < $MF > _conf.tmp

if [ -f /usr/include/lightning.h -o -f lightning.h ]
then
    if [ -f liblightning.a ]
    then LLIB=liblightning.a
    else LLIB=
    fi
    if [ -f lightning.h ]
    then LDEF=-I.
    else LDEF=
    fi

    sed \
	-e 's/^DEFS_LIGHTNING=.*/DEFS_LIGHTNING=-DENABLE_GNULIGHTNING=1 '$LDEF'/' \
	-e 's/^LIBS_LIGHTNING=.*/LIBS_LIGHTNING='$LLIB'/' \
	< _conf.tmp > _comp2.tmp
    mv _comp2.tmp _conf.tmp
fi

[ -x /usr/bin/apt-cache ] && {
    TCCVER="`apt-cache policy libtcc-dev | awk '/Installed:/ {print $2;}'`"
    case "$TCCVER" in
    0.9.25* ) TCCVER='0x000925' ;;
    0.9.26* ) TCCVER='0x000926' ;;
    * ) TCCVER= ;;
    esac
}

if [ "$TCCVER" != "" ]
then sed \
	-e 's/^DEFS_TCCLIB=.*/DEFS_TCCLIB=-DENABLE_TCCLIB='$TCCVER'/' \
	-e 's/^LIBS_TCCLIB=.*/LIBS_TCCLIB=-ltcc -ldl/' \
	< _conf.tmp > _comp2.tmp

    mv _comp2.tmp _conf.tmp
fi

if ! cmp -s $MF _conf.tmp
then echo Updating config
    mv $MF $MF.old
    mv _conf.tmp $MF
fi
